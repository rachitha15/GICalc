{% extends "base.html" %}

{% block title %}Meal Input - Glycemic Guide AI{% endblock %}

{% block header_right %}
<button id="logout-btn" class="text-gray-600 dark:text-white text-sm font-medium hover:underline">Log Out</button>
{% endblock %}

{% block content %}
<style>
    @keyframes breathe {
        0%, 100% { opacity: 0.4; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.1); }
    }
    .animate-breathe {
        animation: breathe 8s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
    }
    .animate-float {
        animation: float 4s ease-in-out infinite;
    }
</style>

<div class="fixed inset-0 pointer-events-none z-0 overflow-hidden">
    <div class="absolute -top-[20%] -left-[10%] w-[600px] h-[600px] bg-primary/20 blur-[120px] rounded-full animate-breathe"></div>
    <div class="absolute top-[40%] -right-[20%] w-[500px] h-[500px] bg-blue-600/10 blur-[100px] rounded-full animate-breathe" style="animation-delay: 2s;"></div>
</div>

<div class="relative z-10 w-full max-w-[540px] mx-auto flex flex-col gap-6">
    <div id="onboarding-cards" class="hidden flex flex-col gap-3">
        <div id="onboarding-card-1" class="onboarding-card bg-gradient-to-r from-primary/20 to-blue-500/20 backdrop-blur-md border border-primary/30 rounded-2xl p-4 relative">
            <button onclick="dismissOnboardingCard(1)" class="absolute top-3 right-3 text-white/50 hover:text-white">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
            <div class="flex items-start gap-3">
                <div class="p-2 rounded-lg bg-primary/20 text-primary shrink-0">
                    <span class="material-symbols-outlined">lightbulb</span>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm mb-1">What is Glycemic Load?</h3>
                    <p class="text-white/70 text-xs leading-relaxed">It measures how much a food will raise your blood sugar. Unlike Glycemic Index, GL considers portion size too - so it's more accurate for real meals.</p>
                </div>
            </div>
        </div>
        <div id="onboarding-card-2" class="onboarding-card hidden bg-gradient-to-r from-green-500/20 to-teal-500/20 backdrop-blur-md border border-green-500/30 rounded-2xl p-4 relative">
            <button onclick="dismissOnboardingCard(2)" class="absolute top-3 right-3 text-white/50 hover:text-white">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
            <div class="flex items-start gap-3">
                <div class="p-2 rounded-lg bg-green-500/20 text-green-400 shrink-0">
                    <span class="material-symbols-outlined">favorite</span>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm mb-1">Why Track GL?</h3>
                    <p class="text-white/70 text-xs leading-relaxed">Stable blood sugar = steady energy, fewer cravings, and better focus. High GL meals cause energy crashes. Aim for GL 10 or less per meal.</p>
                </div>
            </div>
        </div>
        <div id="onboarding-card-3" class="onboarding-card hidden bg-gradient-to-r from-yellow-500/20 to-orange-500/20 backdrop-blur-md border border-yellow-500/30 rounded-2xl p-4 relative">
            <button onclick="dismissOnboardingCard(3)" class="absolute top-3 right-3 text-white/50 hover:text-white">
                <span class="material-symbols-outlined text-lg">close</span>
            </button>
            <div class="flex items-start gap-3">
                <div class="p-2 rounded-lg bg-yellow-500/20 text-yellow-400 shrink-0">
                    <span class="material-symbols-outlined">emoji_objects</span>
                </div>
                <div>
                    <h3 class="text-white font-bold text-sm mb-1">How to Use</h3>
                    <p class="text-white/70 text-xs leading-relaxed">Just type what you ate in plain language. I'll identify foods from our Indian food database or use AI for other items. You'll get personalized tips!</p>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full flex items-center justify-between bg-white/60 dark:bg-[#1e1730]/60 backdrop-blur-md border border-gray-200 dark:border-[#3f3267] rounded-3xl p-4 shadow-lg shadow-indigo-500/5 relative overflow-hidden animate-float transition-transform hover:scale-[1.02] duration-300">
        <div class="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-2xl -mr-10 -mt-10 pointer-events-none"></div>
        <div class="flex flex-col gap-1 relative z-10">
            <span class="text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-widest">Daily Meal Limit</span>
            <div class="flex items-baseline gap-1.5">
                <span id="remaining-count" class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-blue-500">4</span>
                <span class="text-sm font-medium text-gray-500 dark:text-gray-400">/ 4 meals left</span>
            </div>
        </div>
        <div id="battery-display" class="flex items-center gap-2 relative z-10">
        </div>
    </div>

    <div class="text-center space-y-2 mt-2">
        <h2 class="text-3xl md:text-4xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-b from-gray-900 to-gray-600 dark:from-white dark:to-white/70">
            What's on your<br/>plate today?
        </h2>
        <p class="text-base text-gray-500 dark:text-gray-400">
            I'll analyze the glycemic impact for you.
        </p>
    </div>

    <div id="error-message" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl text-sm"></div>

    <div class="group relative rounded-[2rem] bg-white dark:bg-[#1e1730] border border-gray-200 dark:border-[#3f3267] shadow-xl dark:shadow-2xl dark:shadow-primary/5 overflow-hidden transition-all focus-within:ring-4 focus-within:ring-primary/20 focus-within:border-primary">
        <div class="absolute inset-0 bg-gradient-to-b from-primary/5 to-transparent opacity-0 group-focus-within:opacity-100 transition-opacity pointer-events-none"></div>
        <div class="relative flex flex-col h-64 p-5">
            <textarea 
                id="meal-input"
                maxlength="500"
                class="w-full flex-1 bg-transparent border-0 p-0 text-xl md:text-2xl text-gray-900 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-600 focus:ring-0 resize-none font-medium leading-relaxed" 
                placeholder="I had 2 rotis, a bowl of yellow dal, and some dahi..."
            ></textarea>
            <div class="flex justify-between items-end pt-4">
                <span id="char-counter" class="text-xs font-medium text-gray-400">0/500</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-widest opacity-50">AI Ready</span>
            </div>
        </div>
    </div>

    <div class="space-y-3">
        <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider px-2">Quick Add</p>
        <div id="quick-add-pills" class="flex flex-wrap gap-2.5">
            <button data-food="Roti" class="quick-pill flex h-9 items-center gap-1.5 px-4 rounded-full bg-white dark:bg-[#2c2348] border border-gray-200 dark:border-[#3f3267] hover:border-primary dark:hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 text-sm font-medium transition-all hover:-translate-y-0.5 active:scale-95 group">
                <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-primary">add</span>
                Roti
            </button>
            <button data-food="Rice" class="quick-pill flex h-9 items-center gap-1.5 px-4 rounded-full bg-white dark:bg-[#2c2348] border border-gray-200 dark:border-[#3f3267] hover:border-primary dark:hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 text-sm font-medium transition-all hover:-translate-y-0.5 active:scale-95 group">
                <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-primary">add</span>
                Rice
            </button>
            <button data-food="Dal" class="quick-pill flex h-9 items-center gap-1.5 px-4 rounded-full bg-white dark:bg-[#2c2348] border border-gray-200 dark:border-[#3f3267] hover:border-primary dark:hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 text-sm font-medium transition-all hover:-translate-y-0.5 active:scale-95 group">
                <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-primary">add</span>
                Dal
            </button>
            <button data-food="Paneer" class="quick-pill flex h-9 items-center gap-1.5 px-4 rounded-full bg-white dark:bg-[#2c2348] border border-gray-200 dark:border-[#3f3267] hover:border-primary dark:hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 text-sm font-medium transition-all hover:-translate-y-0.5 active:scale-95 group">
                <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-primary">add</span>
                Paneer
            </button>
            <button data-food="Chai" class="quick-pill flex h-9 items-center gap-1.5 px-4 rounded-full bg-white dark:bg-[#2c2348] border border-gray-200 dark:border-[#3f3267] hover:border-primary dark:hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 text-sm font-medium transition-all hover:-translate-y-0.5 active:scale-95 group">
                <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-primary">add</span>
                Chai
            </button>
            <button data-food="Dosa" class="quick-pill flex h-9 items-center gap-1.5 px-4 rounded-full bg-white dark:bg-[#2c2348] border border-gray-200 dark:border-[#3f3267] hover:border-primary dark:hover:border-primary hover:bg-primary/5 dark:hover:bg-primary/20 text-sm font-medium transition-all hover:-translate-y-0.5 active:scale-95 group">
                <span class="material-symbols-outlined text-[18px] text-gray-400 group-hover:text-primary">add</span>
                Dosa
            </button>
        </div>
    </div>

    <button id="calculate-btn" class="relative w-full group overflow-hidden rounded-full p-[2px] focus:outline-none focus:ring-4 focus:ring-primary/30 mt-4 active:scale-[0.98] transition-transform disabled:opacity-50 disabled:cursor-not-allowed">
        <span class="absolute inset-0 bg-gradient-to-r from-primary via-[#7c4dff] to-primary animate-breathe opacity-80"></span>
        <div class="relative flex items-center justify-center gap-2 h-14 w-full rounded-full bg-primary hover:bg-transparent hover:bg-gradient-to-r hover:from-primary hover:to-[#6020f0] transition-all">
            <span id="btn-text" class="text-white text-lg font-bold tracking-wide">Calculate Glycemic Load</span>
            <span id="btn-loading" class="hidden">
                <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
            <span id="btn-arrow" class="material-symbols-outlined text-white group-hover:translate-x-1 transition-transform">arrow_forward</span>
        </div>
    </button>

    <p class="text-center text-xs text-gray-500 dark:text-gray-400 px-6 leading-relaxed">
        Tip: You can enter multiple items at once. I'll separate them and calculate the total load automatically.
    </p>
</div>
{% endblock %}

{% block scripts %}
<script>
function dismissOnboardingCard(cardNum) {
    const card = document.getElementById('onboarding-card-' + cardNum);
    if (card) card.classList.add('hidden');
    
    const nextCard = document.getElementById('onboarding-card-' + (cardNum + 1));
    if (nextCard) {
        nextCard.classList.remove('hidden');
    } else {
        document.getElementById('onboarding-cards').classList.add('hidden');
        localStorage.setItem('onboardingComplete', 'true');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    const onboardingComplete = localStorage.getItem('onboardingComplete');
    if (!onboardingComplete) {
        document.getElementById('onboarding-cards').classList.remove('hidden');
    }
    
    const mealInput = document.getElementById('meal-input');
    const charCounter = document.getElementById('char-counter');
    const calculateBtn = document.getElementById('calculate-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');
    const btnArrow = document.getElementById('btn-arrow');
    const errorDiv = document.getElementById('error-message');
    const remainingCount = document.getElementById('remaining-count');
    const batteryDisplay = document.getElementById('battery-display');
    const quickPills = document.querySelectorAll('.quick-pill');
    
    let mealsRemaining = 4;
    
    async function fetchUserInfo() {
        try {
            const response = await fetch('/auth/me', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                mealsRemaining = data.usage.remaining;
                remainingCount.textContent = mealsRemaining;
                updateBatteryDisplay(mealsRemaining);
                
                if (mealsRemaining <= 0) {
                    calculateBtn.disabled = true;
                    errorDiv.textContent = 'You have reached your daily limit of 4 meal calculations. Please try again tomorrow.';
                    errorDiv.classList.remove('hidden');
                }
            } else if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        } catch (error) {
            console.error('Failed to fetch user info:', error);
        }
    }
    
    function updateBatteryDisplay(remaining) {
        batteryDisplay.innerHTML = '';
        for (let i = 0; i < 4; i++) {
            const cell = document.createElement('div');
            if (i < (4 - remaining)) {
                cell.className = 'relative w-4 h-10 rounded-full bg-gray-200 dark:bg-white/5 border border-gray-300 dark:border-white/10 overflow-hidden';
                cell.innerHTML = '<div class="absolute bottom-0 left-0 right-0 h-[20%] bg-gray-400/30 dark:bg-gray-500/30"></div>';
            } else {
                const opacity = i === (4 - remaining) ? 'opacity-100' : (i === (4 - remaining + 1) ? 'opacity-90' : 'opacity-80');
                cell.className = `relative w-4 h-10 rounded-full bg-gray-900 overflow-hidden shadow-[0_0_12px_rgba(73,19,236,0.5)] border border-primary/30 ${opacity}`;
                cell.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-t from-primary via-blue-600 to-indigo-400 ${i === (4 - remaining) ? 'animate-pulse' : ''}"></div>
                    <div class="absolute top-1 right-1 w-1 h-1 bg-white/50 rounded-full blur-[1px]"></div>
                `;
            }
            batteryDisplay.appendChild(cell);
        }
    }
    
    mealInput.addEventListener('input', function() {
        const length = this.value.length;
        charCounter.textContent = length + '/500';
        
        if (length >= 450) {
            charCounter.classList.add('text-orange-400');
            charCounter.classList.remove('text-gray-400', 'text-red-400');
        } else if (length >= 500) {
            charCounter.classList.add('text-red-400');
            charCounter.classList.remove('text-gray-400', 'text-orange-400');
        } else {
            charCounter.classList.add('text-gray-400');
            charCounter.classList.remove('text-orange-400', 'text-red-400');
        }
    });
    
    quickPills.forEach(pill => {
        pill.addEventListener('click', function() {
            const food = this.dataset.food;
            const currentText = mealInput.value.trim();
            
            if (currentText.length + food.length + 2 > 500) {
                return;
            }
            
            if (currentText) {
                mealInput.value = currentText + ', ' + food;
            } else {
                mealInput.value = food;
            }
            
            mealInput.dispatchEvent(new Event('input'));
            mealInput.focus();
        });
    });
    
    calculateBtn.addEventListener('click', async function() {
        const mealText = mealInput.value.trim();
        
        errorDiv.classList.add('hidden');
        
        if (!mealText) {
            errorDiv.textContent = 'Please enter what you ate before calculating.';
            errorDiv.classList.remove('hidden');
            return;
        }
        
        if (mealsRemaining <= 0) {
            errorDiv.textContent = 'You have reached your daily limit. Please try again tomorrow.';
            errorDiv.classList.remove('hidden');
            return;
        }
        
        calculateBtn.disabled = true;
        btnText.classList.add('hidden');
        btnArrow.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        
        try {
            const response = await fetch('/parse-meal-smart', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ text: mealText })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                localStorage.setItem('parsedMeal', JSON.stringify(data));
                localStorage.setItem('originalMealText', mealText);
                window.location.href = '/review';
            } else if (response.status === 429) {
                errorDiv.textContent = data.message || 'Daily limit reached. Please try again tomorrow.';
                errorDiv.classList.remove('hidden');
                mealsRemaining = 0;
                remainingCount.textContent = 0;
                updateBatteryDisplay(0);
            } else if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
            } else {
                errorDiv.textContent = data.message || 'Failed to parse meal. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        } catch (error) {
            errorDiv.textContent = 'Network error. Please check your connection and try again.';
            errorDiv.classList.remove('hidden');
        } finally {
            calculateBtn.disabled = false;
            btnText.classList.remove('hidden');
            btnArrow.classList.remove('hidden');
            btnLoading.classList.add('hidden');
        }
    });
    
    document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        localStorage.removeItem('usage');
        localStorage.removeItem('parsedMeal');
        localStorage.removeItem('originalMealText');
        window.location.href = '/login';
    });
    
    fetchUserInfo();
});
</script>
{% endblock %}
