{% extends "base.html" %}

{% block title %}Review Meal - Glycemic Guide AI{% endblock %}

{% block header_right %}
<button id="logout-btn" class="text-gray-600 dark:text-white text-sm font-medium hover:underline">Log Out</button>
{% endblock %}

{% block content %}
<style>
    input[type=range] {
        -webkit-appearance: none; 
        background: transparent; 
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 24px;
        width: 24px;
        border-radius: 50%;
        background: #ffffff;
        cursor: pointer;
        margin-top: -10px; 
        box-shadow: 0 0 10px rgba(73, 19, 236, 0.5);
        transition: transform 0.1s ease;
    }
    input[type=range]:active::-webkit-slider-thumb {
        transform: scale(1.2);
    }
    input[type=range]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        cursor: pointer;
        background: #2c2348;
        border-radius: 2px;
    }
    input[type=range]:focus::-webkit-slider-runnable-track {
        background: #4913ec;
    }
    .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, padding 0.3s ease-out;
    }
    .accordion-content.expanded {
        max-height: 1000px;
        transition: max-height 0.4s ease-in;
    }
</style>

<div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
    <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full bg-primary/20 blur-[120px]"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] rounded-full bg-primary/10 blur-[100px]"></div>
</div>

<div class="flex flex-col w-full max-w-3xl mx-auto gap-6 pb-8">
    <div class="flex items-center gap-2 text-white/50 text-sm font-medium pt-2">
        <a href="/dashboard" class="hover:text-white flex items-center gap-1 transition-colors group">
            <span class="material-symbols-outlined text-base group-hover:-translate-x-1 transition-transform">arrow_back</span>
            Back to Meal Input
        </a>
    </div>

    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl md:text-4xl font-bold text-white tracking-tight">Review Meal</h1>
            <p id="subtitle" class="text-white/60 text-lg">Confirm details for <span id="item-count">0</span> detected items</p>
        </div>
        <div class="hidden md:flex items-center gap-2 px-4 py-2 bg-[#201933] rounded-full border border-white/5">
            <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
            <span class="text-sm font-bold text-white/80">AI Analysis Active</span>
        </div>
    </div>

    <div id="error-message" class="hidden bg-red-500/10 border border-red-500/30 text-red-400 px-4 py-3 rounded-xl text-sm"></div>

    <div id="accordion-container" class="flex flex-col gap-3">
    </div>

    <button id="calculate-btn" class="hidden relative w-full group overflow-hidden rounded-full p-[2px] focus:outline-none focus:ring-4 focus:ring-primary/30 active:scale-[0.98] transition-transform disabled:opacity-50 disabled:cursor-not-allowed mt-4">
        <span class="absolute inset-0 bg-gradient-to-r from-primary via-[#7c4dff] to-primary opacity-80"></span>
        <div class="relative flex items-center justify-center gap-2 h-14 w-full rounded-full bg-primary hover:bg-transparent hover:bg-gradient-to-r hover:from-primary hover:to-[#6020f0] transition-all">
            <span id="calculate-btn-text" class="text-white text-lg font-bold tracking-wide">Calculate Glycemic Load</span>
            <span id="calculate-btn-loading" class="hidden">
                <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </span>
            <span id="calculate-btn-arrow" class="material-symbols-outlined text-white group-hover:translate-x-1 transition-transform">arrow_forward</span>
        </div>
    </button>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('token');
    
    if (!token) {
        window.location.href = '/login';
        return;
    }
    
    const parsedMealData = localStorage.getItem('parsedMeal');
    if (!parsedMealData) {
        window.location.href = '/dashboard';
        return;
    }
    
    let mealData;
    try {
        mealData = JSON.parse(parsedMealData);
    } catch (e) {
        window.location.href = '/dashboard';
        return;
    }
    
    if (!mealData.items || mealData.items.length === 0) {
        window.location.href = '/dashboard';
        return;
    }
    
    const items = mealData.items;
    let expandedIndex = -1;
    
    document.getElementById('item-count').textContent = items.length;
    
    const accordionContainer = document.getElementById('accordion-container');
    const calculateBtn = document.getElementById('calculate-btn');
    const calculateBtnText = document.getElementById('calculate-btn-text');
    const calculateBtnLoading = document.getElementById('calculate-btn-loading');
    const calculateBtnArrow = document.getElementById('calculate-btn-arrow');
    const errorDiv = document.getElementById('error-message');
    
    function renderAccordion() {
        accordionContainer.innerHTML = items.map((item, index) => {
            const isExpanded = index === expandedIndex;
            const isConfirmed = item.confirmed;
            const matchType = item.match_type;
            
            let statusText, statusClass, iconName, borderClass;
            
            if (isConfirmed) {
                statusText = 'CONFIRMED';
                statusClass = 'text-green-400';
                iconName = 'check_circle';
                borderClass = 'border-green-400/30';
            } else if (matchType === 'multiple_options') {
                statusText = 'TAP TO SELECT';
                statusClass = 'text-primary';
                iconName = 'touch_app';
                borderClass = 'border-primary/30';
            } else if (matchType === 'ai_estimated') {
                statusText = 'TAP TO CONFIRM';
                statusClass = 'text-pink-400';
                iconName = 'smart_toy';
                borderClass = 'border-pink-400/30';
            } else if (matchType === 'exact_match') {
                statusText = 'TAP TO CONFIRM';
                statusClass = 'text-green-400';
                iconName = 'database';
                borderClass = 'border-green-400/30';
            } else {
                statusText = 'TAP TO SELECT';
                statusClass = 'text-orange-400';
                iconName = 'help';
                borderClass = 'border-orange-400/30';
            }
            
            const selectedName = item.selected ? item.selected.name : item.original_name;
            const selectedUnit = item.selected ? item.selected.unit : 'serving';
            const portionMultiplier = item.portionMultiplier || 1;
            
            const headerBg = isExpanded ? 'bg-primary/20' : (isConfirmed ? 'bg-[#1a2e1a]' : 'bg-[#201933]/70');
            
            return `
                <div class="rounded-2xl border ${isExpanded ? 'border-primary' : borderClass} overflow-hidden transition-all" data-index="${index}">
                    <div onclick="toggleAccordion(${index})" class="flex items-center gap-4 p-4 ${headerBg} cursor-pointer hover:bg-primary/10 transition-colors">
                        <div class="h-12 w-12 rounded-xl ${isConfirmed ? 'bg-green-400/20' : 'bg-[#1a1429]'} flex items-center justify-center ${statusClass} shrink-0 border border-white/5">
                            <span class="material-symbols-outlined">${iconName}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-white font-bold truncate">${selectedName}</h3>
                            <p class="${statusClass} text-xs font-bold uppercase tracking-wider">${statusText}</p>
                        </div>
                        ${isConfirmed ? `
                            <div class="text-right mr-2">
                                <p class="text-white font-medium text-sm">${portionMultiplier.toFixed(1)} ${selectedUnit}</p>
                            </div>
                        ` : ''}
                        <span class="material-symbols-outlined text-white/50 transition-transform ${isExpanded ? 'rotate-180' : ''}">expand_more</span>
                    </div>
                    
                    <div class="accordion-content ${isExpanded ? 'expanded' : ''}" id="content-${index}">
                        <div class="p-4 pt-2 bg-[#1a1429]/50 border-t border-white/5">
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-white/70 uppercase tracking-wider mb-3">Select Type</h4>
                                <div id="options-${index}" class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                    ${renderOptionsHTML(item, index)}
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="text-sm font-bold text-white/70 uppercase tracking-wider mb-3">Adjust Portion</h4>
                                <div class="bg-[#201933]/70 rounded-xl p-4 border border-white/5">
                                    <div class="flex items-center justify-between mb-4">
                                        <div class="flex items-center gap-2">
                                            <input type="number" id="portion-input-${index}" min="0.1" max="10" step="0.1" value="${portionMultiplier.toFixed(1)}" 
                                                   onchange="updatePortion(${index}, this.value)"
                                                   class="w-16 text-2xl font-bold text-white bg-transparent text-center focus:outline-none border-b border-white/20 focus:border-primary [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none">
                                            <span class="text-white/60" id="unit-${index}">${selectedUnit}</span>
                                        </div>
                                        <span id="grams-${index}" class="text-green-400 text-sm">~${Math.round((item.selected?.grams_per_unit || 150) * portionMultiplier)} grams</span>
                                    </div>
                                    <input type="range" id="slider-${index}" min="0.1" max="4" step="0.1" value="${Math.min(portionMultiplier, 4)}" 
                                           oninput="updatePortionFromSlider(${index}, this.value)"
                                           class="w-full mb-3">
                                    <div class="flex justify-center gap-2">
                                        <button onclick="setPortionSize(${index}, 0.5)" class="size-btn-${index} px-4 py-2 rounded-lg ${Math.abs(portionMultiplier - 0.5) < 0.1 ? 'bg-primary text-white' : 'bg-[#2c2348] text-white/60'} text-sm font-medium hover:bg-primary/50 transition-all">Small</button>
                                        <button onclick="setPortionSize(${index}, 1)" class="size-btn-${index} px-4 py-2 rounded-lg ${Math.abs(portionMultiplier - 1) < 0.1 ? 'bg-primary text-white' : 'bg-[#2c2348] text-white/60'} text-sm font-medium hover:bg-primary/50 transition-all">Medium</button>
                                        <button onclick="setPortionSize(${index}, 1.5)" class="size-btn-${index} px-4 py-2 rounded-lg ${Math.abs(portionMultiplier - 1.5) < 0.1 ? 'bg-primary text-white' : 'bg-[#2c2348] text-white/60'} text-sm font-medium hover:bg-primary/50 transition-all">Large</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="confirmItem(${index})" 
                                    class="w-full py-3 rounded-xl bg-primary hover:bg-primary/80 text-white font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                                    ${!item.selected ? 'disabled' : ''}>
                                ${item.selected ? 'Confirm & Continue' : 'Select an option first'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        updateCalculateButton();
    }
    
    function renderOptionsHTML(item, itemIndex) {
        const options = [];
        
        if (item.db_options && item.db_options.length > 0) {
            item.db_options.forEach((opt, idx) => {
                const isSelected = item.selected && item.selected.name === opt.name && item.selected.source !== 'ai_estimated';
                options.push({ ...opt, isSelected, optionIndex: idx, type: 'db' });
            });
        }
        
        if (item.ai_option) {
            const isSelected = item.selected && item.selected.source === 'ai_estimated';
            options.push({ ...item.ai_option, isSelected, optionIndex: 'ai', type: 'ai' });
        }
        
        if (options.length === 0) {
            return '<p class="text-white/40 text-sm col-span-2">No options available</p>';
        }
        
        return options.map(opt => {
            const selectedClass = opt.isSelected 
                ? 'bg-primary/20 border-primary' 
                : 'bg-[#1a1429] border-white/10 hover:border-white/30';
            const badgeClass = opt.type === 'ai' 
                ? 'bg-pink-400/10 text-pink-400' 
                : 'bg-green-400/10 text-green-400';
            const badgeText = opt.type === 'ai' ? 'AI' : 'DB';
            
            return `
                <div onclick="selectOption(${itemIndex}, '${opt.optionIndex}')" 
                     class="flex items-center gap-3 p-3 rounded-xl ${selectedClass} border cursor-pointer transition-all hover:scale-[1.01]">
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium text-sm truncate">${opt.name}</p>
                        <span class="px-1.5 py-0.5 rounded ${badgeClass} text-[10px] font-bold">${badgeText}</span>
                    </div>
                    <div class="h-5 w-5 rounded-full ${opt.isSelected ? 'bg-primary flex items-center justify-center' : 'border border-white/30'}">
                        ${opt.isSelected ? '<span class="material-symbols-outlined text-xs text-white">check</span>' : ''}
                    </div>
                </div>
            `;
        }).join('');
    }
    
    window.toggleAccordion = function(index) {
        if (expandedIndex === index) {
            expandedIndex = -1;
        } else {
            expandedIndex = index;
        }
        renderAccordion();
    };
    
    window.selectOption = function(itemIndex, optionIndex) {
        const item = items[itemIndex];
        
        if (optionIndex === 'ai') {
            item.selected = { ...item.ai_option };
        } else {
            item.selected = { ...item.db_options[parseInt(optionIndex)] };
        }
        
        item.portionMultiplier = item.portionMultiplier || 1;
        renderAccordion();
    };
    
    window.updatePortion = function(index, value) {
        const item = items[index];
        let val = parseFloat(value);
        if (isNaN(val) || val < 0.1) val = 0.1;
        if (val > 10) val = 10;
        item.portionMultiplier = val;
        renderAccordion();
    };
    
    window.updatePortionFromSlider = function(index, value) {
        const item = items[index];
        item.portionMultiplier = parseFloat(value);
        
        const input = document.getElementById(`portion-input-${index}`);
        const grams = document.getElementById(`grams-${index}`);
        if (input) input.value = item.portionMultiplier.toFixed(1);
        if (grams && item.selected) {
            grams.textContent = `~${Math.round(item.selected.grams_per_unit * item.portionMultiplier)} grams`;
        }
        
        document.querySelectorAll(`.size-btn-${index}`).forEach(btn => {
            const size = parseFloat(btn.textContent === 'Small' ? 0.5 : btn.textContent === 'Medium' ? 1 : 1.5);
            if (Math.abs(size - item.portionMultiplier) < 0.1) {
                btn.classList.remove('bg-[#2c2348]', 'text-white/60');
                btn.classList.add('bg-primary', 'text-white');
            } else {
                btn.classList.remove('bg-primary', 'text-white');
                btn.classList.add('bg-[#2c2348]', 'text-white/60');
            }
        });
    };
    
    window.setPortionSize = function(index, size) {
        const item = items[index];
        item.portionMultiplier = size;
        renderAccordion();
    };
    
    window.confirmItem = function(index) {
        const item = items[index];
        if (!item.selected) return;
        
        item.confirmed = true;
        item.portionMultiplier = item.portionMultiplier || 1;
        
        const nextUnconfirmed = items.findIndex((i, idx) => idx > index && !i.confirmed);
        if (nextUnconfirmed !== -1) {
            expandedIndex = nextUnconfirmed;
        } else {
            const firstUnconfirmed = items.findIndex(i => !i.confirmed);
            if (firstUnconfirmed !== -1) {
                expandedIndex = firstUnconfirmed;
            } else {
                expandedIndex = -1;
            }
        }
        
        renderAccordion();
    };
    
    function updateCalculateButton() {
        const allConfirmed = items.every(item => item.confirmed);
        if (allConfirmed) {
            calculateBtn.classList.remove('hidden');
        } else {
            calculateBtn.classList.add('hidden');
        }
    }
    
    calculateBtn.addEventListener('click', async function() {
        calculateBtn.disabled = true;
        calculateBtnText.classList.add('hidden');
        calculateBtnArrow.classList.add('hidden');
        calculateBtnLoading.classList.remove('hidden');
        
        const mealItems = items.map(i => ({
            food: i.selected.name,
            quantity: i.quantity * i.portionMultiplier,
            gi: i.selected.gi,
            unit: i.selected.unit,
            grams: Math.round(i.selected.grams_per_unit * i.portionMultiplier),
            carbs_per_unit: i.selected.carbs_per_unit,
            fiber_per_unit: i.selected.fiber_per_unit,
            source: i.selected.source
        }));
        
        try {
            const response = await fetch('/calculate-gl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ meal: mealItems })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                localStorage.setItem('glResult', JSON.stringify(data));
                localStorage.removeItem('parsedMeal');
                window.location.href = '/results';
                return;
            } else {
                errorDiv.textContent = data.message || 'Failed to calculate glycemic load.';
                errorDiv.classList.remove('hidden');
            }
        } catch (error) {
            errorDiv.textContent = 'Network error. Please try again.';
            errorDiv.classList.remove('hidden');
        } finally {
            calculateBtn.disabled = false;
            calculateBtnText.classList.remove('hidden');
            calculateBtnArrow.classList.remove('hidden');
            calculateBtnLoading.classList.add('hidden');
        }
    });
    
    document.getElementById('logout-btn').addEventListener('click', function() {
        localStorage.clear();
        window.location.href = '/login';
    });
    
    renderAccordion();
});
</script>
{% endblock %}
